<p id="notice"><%= notice %></p>

<div class="align">
  <p>
    <%= image_tag @listing.motorhome.uploaded_image %>
  </p>
</div>

<% if @listing.motorhome.user != current_user %>
  <% if Claim.exists?(user: current_user, listing: @listing) %>
    You Have Made A Booking For This Listing
  <% else %>
    <%= render partial: 'claims/form', locals: {claim: Claim.new, listing: @listing, status: false} %>
  <% end %>
<% else %>
  <% if Claim.exists?(listing: @listing) %>
    Users who have made a booking;
    <div class="align">
    <table>
      <thead>
        <tr>
          <th>Avatar</th>
          <th>Name</th>
          <th>Address</th>
          <th>Phone</th>
          <th colspan="2"></th>
        </tr>
      </thead>

      <tbody>
        <% if Claim.exists?(approved: true) %>
          <% claim = Claim.where(approved: true).first %>
          <tr>
            <td><% if claim.user.profile.avatar.attached? %>
              <%= image_tag claim.user.profile.avatar, class: 'avatar' %>
            <% else %>
              <p>No avatar for this user</p>
            <% end %></td>
            <td><%= link_to claim.user.profile.name, claim.user.profile %></td>
            <td><%= claim.user.profile.address %></td>
            <td><%= claim.user.profile.phone %></td>
            <td>I Have Booked This Listing!</td>
          </tr>
        <% else %>
          <% @claims.each do |claim| %>
            <tr>
              <td><% if claim.user.profile.avatar.attached? %>
                <%= image_tag claim.user.profile.avatar, class: 'avatar' %>
              <% else %>
                <p>No avatar for this user</p>
              <% end %></td>
              <td><%= link_to claim.user.profile.name, claim.user.profile %></td>
              <td><%= claim.user.profile.address %></td>
              <td><%= claim.user.profile.phone %></td>
              <td><%= link_to 'Reject', claim, method: :delete, data: { confirm: 'Are you sure?' } %></td>
              <td><%= link_to 'Approve', claim_path(claim: {listing_id: claim.listing.id, user_id: claim.user.id, approved: true}, id: claim.id), method: :patch, data: { confirm: 'Are you sure?' } %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
    </div>
  <% else %>
    No Bookings
  <% end %>
<% end %>

<p>
  <%= image_tag @listing.motorhome.user.profile.avatar, class: 'avatarsmall' %><%= link_to @listing.motorhome.user.profile.name, @listing.motorhome.user.profile %>
</p>

<p>
  <strong>Date from:</strong>
  <%= @listing.start_time %>
</p>

<p>
  <strong>Date to:</strong>
  <%= @listing.end_time %>
</p>

<p>
  <strong>Price:</strong>
  $<%= @listing.price %>
</p>

<p>
  <strong>Make:</strong>
  <%= @listing.motorhome.make %>
</p>
<p>
  <strong>Model:</strong>
  <%= @listing.motorhome.model %>
</p>
<p>
  <strong>Year:</strong>
  <%= @listing.motorhome.year %>
</p>

</div>
<div class="align">

<%= month_calendar events: @listings do |date, listings| %>
  <%= date %>

  <% listings.each do |listings| %>
    <% if current_user.id == listings.user_id %>
    <div>
      <%= listings.motorhome.make %>
    </div>
    <% end %>
  <% end %>
<% end %>
</div>
<div>
<%= link_to 'Edit', edit_listing_path(@listing) %> |
<%= link_to 'Back', listings_path %>
</div>
